<!DOCTYPE html>
<html>
<head>
<title>Drawpad - draw with your Leap</title>
<script>
var ws, isdrawing, add;

add=320;
//Support Firefox
if (!typeof(WebSocket) && typeof(MozWebSocket)) {
  WebSocket = MozWebSocket;
}

function fingerDown(x,y,z) {
  addTap(x, y);
  redraw();
}

function fingerMove(x,y,z) {
    if(isdrawing){
      addTap(x, y, true);
      redraw();
  }
}

var tapX = new Array();
var tapY = new Array();
var tapDrag = new Array();

function addTap(x, y, dragging)
{
  tapX.push(x+add);
  tapY.push((y*-1)+600);
  tapDrag.push(dragging);
}

// Create the socket with event handlers
function init() {
  isdrawing = false;
  
  //Create and open the socket
  ws = new WebSocket("ws://localhost:6437/");
  
  //On connection
  ws.onopen = function(event) {
    document.getElementById("main").style.visibility = "visible";
    document.getElementById("connection").innerHTML = "Leap connection good!";
  };
  
  //On new message
  ws.onmessage = function(event) {
    var obj = JSON.parse(event.data);
    var str = JSON.stringify(obj, undefined, 2);
    isdrawing=false;
    
    if (obj) {
    if (obj.pointables) {
    if (obj.pointables[0]) {

      if (!isdrawing) {
        fingerDown(obj.pointables[0].tipPosition[0], obj.pointables[0].tipPosition[1], obj.pointables[0].tipPosition[2]);
      }
      else {
       fingerMove(obj.pointables[0].tipPosition[0], obj.pointables[0].tipPosition[1], obj.pointables[0].tipPosition[2]);
      }
      
            isdrawing=true;
      
      //detect tool type
      if (obj.pointables[0].tool) { document.getElementById("tool").innerHTML = "Tool: True" }
      else {
        document.getElementById("tool").innerHTML = "Tool: False"
      }
    }
    }
  }
    document.getElementById("output").innerHTML = '<pre>' + str + '</pre>';
  };
  
  if (!isdrawing) { tapX= []; tapY=[] }
  
  //On socket close
  ws.onclose = function(event) {
    ws = null;
    document.getElementById("main").style.visibility = "hidden";
    document.getElementById("connection").innerHTML = "Leap connection killed";
  }
  
  //On socket error
  ws.onerror = function(event) {
    alert("Received error");
  };
  

}

    function setStuffUp() {
    canvas = document.getElementById('canvas').getContext("2d");
  }
  
  function redraw() {
    canvas.width = canvas.width; // Clears the canvas
  
  canvas.strokeStyle = "#000000";
  canvas.lineJoin = "round";
  canvas.lineWidth = 5;
    	
  for(var i=0; i < tapX.length; i++)
  {		
    canvas.beginPath();
    if(tapDrag[i] && i){
      canvas.moveTo(tapX[i-1], tapY[i-1]);
     }else{
       canvas.moveTo(tapX[i]-1, tapY[i]);
     }
     canvas.lineTo(tapX[i], tapY[i]);
     canvas.closePath();
     canvas.stroke();
  }
  
  tapX = []; tapY=[]
  }
</script>
</head>
<body onload="init();">
<h1>Drawpad Data:</h1>
<h2 id="tool">Tool: False</h2>
<div id="connection">Connect your Leap!</div>
<canvas width="600" height="600" id="canvas">It appears your browser doesn't support Canvas! We kindly advise you to get back in your time machine and set it for 1994, idiot.</canvas>
<div id="main" style="visibility:hidden">
  <p>JSON data:</p>
  <div id="output"></div>
</div>
<script>
  setStuffUp();
</script>
</body>
</html>
